name: Deploy

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'testnet'
        type: choice
        options:
          - testnet
          - mainnet
      contracts:
        description: 'Contracts to deploy (comma-separated or "all")'
        required: true
        default: 'all'
        type: string
  release:
    types: [published]

env:
  FOUNDRY_PROFILE: ci

jobs:
  # ============ Pre-deployment Checks ============
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run tests
        run: forge test -vvv

      - name: Check contract sizes
        run: forge build --sizes

  # ============ Deploy to Testnet ============
  deploy-testnet:
    name: Deploy to BSC Testnet
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: github.event.inputs.network == 'testnet' || github.event_name == 'release'
    environment: testnet
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy contracts
        run: |
          echo "Deploying to BSC Testnet..."
          # forge script script/Deploy.s.sol:DeployScript \
          #   --rpc-url ${{ secrets.BSC_TESTNET_RPC_URL }} \
          #   --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY }} \
          #   --broadcast \
          #   --verify \
          #   --etherscan-api-key ${{ secrets.BSCSCAN_API_KEY }}
          echo "Deployment script placeholder - uncomment when Deploy.s.sol is ready"
        env:
          BSC_TESTNET_RPC_URL: ${{ secrets.BSC_TESTNET_RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          BSCSCAN_API_KEY: ${{ secrets.BSCSCAN_API_KEY }}

      - name: Verify contracts
        run: |
          echo "Verifying contracts on BSCScan Testnet..."
          # forge verify-contract commands here
          echo "Verification placeholder"

  # ============ Deploy to Mainnet ============
  deploy-mainnet:
    name: Deploy to BSC Mainnet
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: github.event.inputs.network == 'mainnet'
    environment: mainnet
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Deploy contracts
        run: |
          echo "Deploying to BSC Mainnet..."
          # IMPORTANT: Mainnet deployment requires multi-sig approval
          # forge script script/Deploy.s.sol:DeployScript \
          #   --rpc-url ${{ secrets.BSC_MAINNET_RPC_URL }} \
          #   --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY }} \
          #   --broadcast \
          #   --verify \
          #   --etherscan-api-key ${{ secrets.BSCSCAN_API_KEY }} \
          #   --slow
          echo "Mainnet deployment placeholder - requires manual approval"
        env:
          BSC_MAINNET_RPC_URL: ${{ secrets.BSC_MAINNET_RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          BSCSCAN_API_KEY: ${{ secrets.BSCSCAN_API_KEY }}

      - name: Verify contracts
        run: |
          echo "Verifying contracts on BSCScan Mainnet..."
          echo "Verification placeholder"

  # ============ Post-deployment ============
  post-deploy:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-testnet, deploy-mainnet]
    if: always() && (needs.deploy-testnet.result == 'success' || needs.deploy-mainnet.result == 'success')
    steps:
      - uses: actions/checkout@v4

      - name: Update deployment records
        run: |
          echo "Recording deployment addresses..."
          echo "Network: ${{ github.event.inputs.network }}"
          echo "Commit: ${{ github.sha }}"
          # Create deployment record file

      - name: Notify team
        run: |
          echo "Deployment completed successfully!"
          # Add Slack/Discord notification here
